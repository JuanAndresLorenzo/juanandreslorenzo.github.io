// ==========================================
// COMBINED GOOGLE APPS SCRIPT
// Handles both Drive uploads and Sheets registration
// ==========================================

// CONFIGURATION
const DRIVE_FOLDER_ID = 'YOUR_FOLDER_ID_HERE'; // For file uploads
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE'; // For data registration

// ==========================================
// MAIN HANDLER - Routes requests
// ==========================================
function doPost(e) {
  try {
    // Check if it's a file upload or data registration
    if (e.parameter.fileData) {
      return handleFileUpload(e);
    } else {
      return handleDataRegistration(e);
    }
  } catch (error) {
    return createResponse({
      status: 'error',
      message: error.toString()
    });
  }
}

// ==========================================
// HANDLE GET REQUEST (For CORS)
// ==========================================
function doGet(e) {
  return createResponse({ message: 'Use POST method' });
}

// ==========================================
// FILE UPLOAD TO GOOGLE DRIVE
// ==========================================
function handleFileUpload(e) {
  try {
    // Decode and create file blob
    const fileBlob = Utilities.newBlob(
      Utilities.base64Decode(e.parameter.fileData),
      e.parameter.mimeType,
      e.parameter.fileName
    );
    
    // Get the folder
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    
    // Save file to Drive
    const file = folder.createFile(fileBlob);
    
    // Return success with file URL
    return createResponse({
      success: true,
      message: 'File uploaded successfully',
      fileUrl: file.getUrl(),
      fileId: file.getId()
    });
    
  } catch (error) {
    return createResponse({
      success: false,
      message: 'Upload failed: ' + error.toString()
    });
  }
}

// ==========================================
// DATA REGISTRATION TO GOOGLE SHEETS
// ==========================================
function handleDataRegistration(e) {
  try {
    // Parse JSON data from parameter
    const data = JSON.parse(e.parameter.data);
    
    // Write to sheets
    writeDataToSheet(data);
    
    return createResponse({
      status: 'success',
      message: 'Data registered successfully'
    });
    
  } catch (error) {
    return createResponse({
      status: 'error',
      message: 'Registration failed: ' + error.toString()
    });
  }
}

// ==========================================
// WRITE DATA TO SHEETS
// ==========================================
function writeDataToSheet(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  // Get or create "Operations" sheet
  let operationsSheet = ss.getSheetByName('Operations');
  if (!operationsSheet) {
    operationsSheet = ss.insertSheet('Operations');
    operationsSheet.appendRow([
      'OperationId', 'Mail', 'AttachmentUrl', 'Total', 
      'ReleaseId', 'Status', 'QtyOfPeople', 'Timestamp'
    ]);
  }
  
  // Get or create "Tickets" sheet
  let ticketsSheet = ss.getSheetByName('Tickets');
  if (!ticketsSheet) {
    ticketsSheet = ss.insertSheet('Tickets');
    ticketsSheet.appendRow([
      'OperationId', 'TicketId', 'FirstName', 'LastName', 'Id', 'Timestamp'
    ]);
  }
  
  // Write operation data
  const timestamp = new Date();
  operationsSheet.appendRow([
    data.OperationId,
    data.Mail,
    data.AttachmentUrl,
    data.Total,
    data.ReleaseId,
    data.Status,
    data.QtyOfPeople,
    timestamp
  ]);
  
  // Write tickets data
  if (data.Tickets && data.Tickets.length > 0) {
    data.Tickets.forEach(ticket => {
      ticketsSheet.appendRow([
        data.OperationId,
        ticket.TicketId,
        ticket.FirstName,
        ticket.LastName,
        ticket.Id,
        timestamp
      ]);
    });
  }
}

// ==========================================
// HELPER FUNCTION - Create JSON Response with CORS
// ==========================================
function createResponse(data) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

// ==========================================
// TEST FUNCTION - File Upload
// ==========================================
function testFileUpload() {
  // You would need to manually create a base64 string to test
  Logger.log('File upload test - use the web interface to test');
}

// ==========================================
// TEST FUNCTION - Data Registration
// ==========================================
function testDataRegistration() {
  const testData = {
    "OperationId": 1,
    "Mail": "test@example.com",
    "AttachmentUrl": "http://example.com/file",
    "Total": 12345,
    "ReleaseId": 1,
    "Status": "Pending",
    "QtyOfPeople": 3,
    "Tickets": [
      {
        "TicketId": 1,
        "FirstName": "Juan",
        "LastName": "Perez",
        "Id": "12345678"
      },
      {
        "TicketId": 2,
        "FirstName": "Maria",
        "LastName": "Garcia",
        "Id": "87654321"
      },
      {
        "TicketId": 3,
        "FirstName": "Pedro",
        "LastName": "Lopez",
        "Id": "11223344"
      }
    ]
  };
  
  writeDataToSheet(testData);
  Logger.log('Test data written successfully');
}
